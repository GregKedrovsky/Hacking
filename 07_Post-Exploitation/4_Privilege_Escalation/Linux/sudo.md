# Linux Privilege Escalation: SUDO Privileges

## Contents
- [What are we looking for?](#what-are-we-looking-for)
- [Standard Local Enumeration](#standard-local-enumeration)
  - [`sudo -l`](#sudo--l)
  - [Results](#results)
  - [The Vulnerability](#the-vulnerability)
- [The Hack: `sudo man [command]`](#the-hack-sudo-man-command)

## What are we looking for?
- We are looking for poorly configured binaries (executables) on the compromised Linux system.
  - We can use these binaries to elevate our privileges
- Many binaries in Linux can be used to execute specific commands.
  - If a binary has sudo privileges attached (without a password), you may be able to use that binary to spawn a shell (thus gaining root privs). 

## Standard Local Enumeration

### `sudo -l`
```
cat /etc/passwd     #find out what other users are configured on the system
sudo -l
```
-  `-l` (lowercase "L" for list) list out the sudo commands the current user can run.
-  [From the man page](https://linux.die.net/man/8/sudo): The `-l` (list) option will list the allowed (and forbidden) commands for the invoking user (or the user specified by the -U option) on the current host.

### Results
- Assume we found a binary we can run with sudo privileges: `/sur/bin/man`
- And the "NOPASSWD" option has been set
- So we can run that command as root without any password or authentication
- This is a misconfiguration we can exploit (see below).
- Use [GTFOBins](https://gtfobins.github.io/) to look up how to compromise the binary file you and use with sudo.

### The Vulnerability
- The `man` utility (to display "man pages") allows you to spawn a Bash shell via the utility itself.
- The normal way you'd open a man page is `man [command]`.
  - This will open the man page with the current user's privileges.
- But if you can run `/usr/bin/man` with root privs using `sudo` (because it's set with "NOPASSWD"), then you can open a shell as root.
  - Preface the `man` comand with `sudo`. That runs the command with root privileges: `sudo man [command]`
  - And since the system is configured to run `/usr/bin/man` via sudo without a password, you are not prompted for any authentication. 

## [The Hack](https://gtfobins.github.io/gtfobins/man/#sudo): `sudo man [command]`
- Open a man page (any man page) with sudo: `sudo man [command]` 
- It parses out the contents of the man page with "more"
- While the man page is displayed, you can enter commands with the "!"
  - Example:  `!/bin/bash`
  - This is a function of more not of man.
  - [From the more man page](https://man7.org/linux/man-pages/man1/more.1.html): `!command` or `:!command` : Execute command in a subshell.
  - `less` works the same way.
- This results in a Bash session as root (the owner of the man process from which the shell was spawned).

## [Security Bypass](https://www.exploit-db.com/exploits/47502) - CVE-2019-14287
> If you have sudo < 1.8.28 this should work.

1. Check for the user sudo permissions
- You can either run a `sudo -l` or `cat` out the **/etc/sudoers/** file.
- You are looking for this configuration: 
```
# from sudo -l: 
User hacker may run the following commands on kali:
  (ALL, !root) /bin/bash
# or in /etc/sudoers:
hacker ALL=(ALL,!root) /bin/bash
```

2. Exploit: 
- Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the sudo privilege.
- `-u#-1` returns as 0 which is root's id
- And then /bin/bash is executed with root permission:
```
sudo -u#-1 /bin/bash
```

## CVE-2019-18634 - pwfeedback

3. [TryHackMe Walk-Through](https://tryhackme.com/r/room/sudovulnsbypass)
