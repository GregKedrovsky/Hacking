# Linux: Dump & Crack Password Hashes
> With Linux (and unlike Windows: pass-the-hash, etc.) there is not a lot you can do with password hashes except try to crack them.


## Content
- [Files Relevant to Password Hashes](#files-relevant-to-password-hashes)
  - [/etc/passwd](#etcpasswd)
  - [/etc/shadow](#etcshadow)
- [Linux Password Hashes](#linux-password-hashes)
  - [/etc/shadow Fields & Format](#etcshadow-fields--format)
  - [Colon Delimited Fields](#colon-delimited-fields)
  - [Password Field & Hash Algorithm](#password-field--hash-algorithm)
- [MetaSploit: Dump & Crack](#metasploit-dump--crack)
  - [The Setup](#the-setup)
  - [Upgrade Your Session](#upgrade-your-session)
  - [Dump the Password Hashes](#dump-the-password-hashes)
  - [Crack the Password Hashes](#crack-the-password-hashes)
- [Manual: Dump & Crack](#manual-dump--crack)
  - [John the Ripper](#john-the-ripper)
    - [Step 1: Unshadow](#step-1-unshadow)
    - [Step 2: Crack](#step-2-crack)
    - [Show Cracked Passwords](#show-cracked-passwords)
  - [Hashcat](#hashcat)
    - [Step 1: Hash to File](#step-1-hash-to-file)
      - [Remember the Field Structure: ](#remember-the-field-structure)
      - [Copy Just the Hashes](#copy-just-the-hashes)
    - [Step 2: Find the Hash Mode](#step-2-find-the-hash-mode)
    - [Step 3: Crack (Syntax)](#step-3-crack-syntax)
    - [Options (Summary)](#options-summary)
    - [Show Cracked Passwords](#show-cracked-passwords-1)

## Files Relevant to Password Hashes
- Linux has mult-user support and as a result multiple users can access the system simultaneously.
- This can be seen as both an advantage and a disadvantage from a security perspective.
- Multiple accounts offer multiple access vectors for attakers and therefore increase the overall risk of the server/system.

### /etc/passwd
- All of the information for all accounts on Linux is stored in the `/etc/passwd` file.
- We cannot view the passwords for the users in the passwd file because they are encrypted and the passwd file is readable by any user on the system. 

### /etc/shadow
- All the encrypted passwords for the users are stored in the `/etc/shadow` file. 
- The shadow file can only be accessed and read by root (or a user account who is part of the root group or who has sudo privileges).
- This is a very important security feature as it prevents other accounts on the system from accessing the hashed passwords.

## Linux Password Hashes
- The `/etc/shadow` file gives us information in regards to the **hashing algorithm** that is being used and the password hash.
- This is very helpful as we are able to determine the type of hashing algorithm that is being used and its strength.
- We can determine this by looking at the number after the username encapsulated (prefixed) by the dollar sign symbol.

### /etc/shadow Fields & Format
```
mark:$6$.n.:17736:0:99999:7:::
[--] [----] [---] - [---] ----
|      |      |   |   |   |||+-----------> 9. Unused
|      |      |   |   |   ||+------------> 8. Expiration date
|      |      |   |   |   |+-------------> 7. Inactivity period
|      |      |   |   |   +--------------> 6. Warning period
|      |      |   |   +------------------> 5. Maximum password age
|      |      |   +----------------------> 4. Minimum password age
|      |      +--------------------------> 3. Last password change
|      +---------------------------------> 2. Encrypted Password
+----------------------------------------> 1. Username
```
Source: https://linuxize.com/post/etc-shadow-file/

### Colon Delimited Fields

| # | Field | Description |
|---| ----- | ------------|
| 1 | username | A valid account name, which exist on the system |
| 2 | password | Enrypted password; hash indicated by `$#$` |
| 3 | Last password change | The date of the last password change, expressed as the number of days since Jan 1, 1970 (Unix time).  | 
| 4 | Minimum password age | The minimum number of days required between password changes | 
| 5 | Maximum password age | The maximum number of days the password is valid | 
| 6 | Warning period | The number of days before expiry when user is warned to change password | 
| 7 | Inactivity period | The number of days after expiry that account is disabled | 
| 8 | Expiration date | The account expiry date (unix time) | 
| 9 | Unused | n/a |

### Password Field & Hash Algorithm
- Your encrypted password is in hash format.
- The password should be minimum 15-20 characters long including special characters, digits, lower case alphabetic and more.
- Usually password format is set to `$id$salt$hashed`, The `$id` is the algorithm prefix used On GNU/Linux as follows:
  - `$1$` is MD5
  - `$2a$` is Blowfish
  - `$2y$` is Eksblowfish
  - `$5$` is SHA-256
  - `$6$` is SHA-512
  - `$y$` is yescrypt
- MD5 and Blowfish are fairly easy to crack. 

## MetaSploit: Dump & Crack
> This is from a lab. The assumption is that you have gained initial and root access to a Linux machine.

### The Setup
- Assumption: You gained an interactive shell (`/bin/bash -i`) from your initial exploit using MetaSploit.
- Assumption: You have root access, but shell only.
- Background your shell session (ctrl-z or bg or background).

### Upgrade Your Session
```
> sessions -u 1
```
- `-u` is for upgrade
- `1`  is the session id number for your shell access to the target
- When you hit enter you should get a meterpreter session in additional to your shell session.
- Background your meterpreter session (ctrl-z or bg or background).

### Dump the Password Hashes
```
> search hashdump
  # Looking for the Linux hashdump module
> use /post/linux/gather/hashdump
> show options
> set SESSION [meterpreter session id#]
> run
```
- This will automagically get all the user accounts that have passwords and therefore hashes.
- Metasploit will save those hashes in a special "unshadowed" file:
  - Example: `/root/.msf4/loot/20231129022617_default_192.95.124.3_linux.hashes_000543.txt'
- That file contains the hashes in a form ready to be cracked.

### Crack the Password Hashes
```
> search crack_linux
> use auxiliary/analyze/crack_linux
  # Password Cracker: Linux
> set [options]
  # apparently it knows to look into the /root/.msf4/ subdir and just tries to crack all it found in there
```
- You should get a green `[+]` and plaintext username/password if successful

## Manual: Dump & Crack
> We can grab the password hashes directly from the /etc/shadow file and attempt to crack them with John the Ripper and/or Hashcat.

### [John the Ripper](https://www.openwall.com/john/doc/EXAMPLES.shtml)

#### Step 1: Unshadow
- If your system is ancient enough that it keeps passwords right in the world-readable /etc/passwd, simply make a copy of that file.
- However, if your system uses shadow passwords, you may use John's "unshadow" utility to obtain the traditional Unix password file: 
```
unshadow /etc/passwd /etc/shadow > unshadowed.txt
```

#### Step 2: Crack
```
john unshadowed.txt
# this is the default

john unshadowed.txt --wordlist=/usr/share/wordlists/rockyou.txt
# use a custom wordlist to crack

john --format=sha512crypt unshadowed.txt --wordlist=/usr/share/wordlists/rockyou.txt
# use a custom wordlist and specifiy the encryption algorythm ($6$ is SHA-512)
```

#### Show Cracked Passwords
```
john --show unshadowed.txt
```

### [Hashcat](https://www.makeuseof.com/use-hashcat-to-crack-hashes-linux/)

#### Step 1: [Hash to File](https://null-byte.wonderhowto.com/how-to/crack-shadow-hashes-after-getting-root-linux-system-0186386/)
- Unlike John, the easiest way to use Hashcat is to **_only_** supply the password hashes themselves.
- Copy any hashes from the /etc/shadwo file that you want to crack. Copy them into a plain text file.

##### Remember the Field Structure: 
- The fields are delimited with a colon (`:`)
- The first field is the username.
- The second field is the encrypted password: 
```
root:$1$/avpfBJ1$x0z8w5UF9Iv./DR9E9Lid.:14747:0:99999:7:::
#    |1|  salt  |        hash          |   other crap    |
```
- Look at the characters following the username "root".
- The `$1$` value indicates the password hashing algorith (ND5 in this case)
- The characters after `$1$`, up to the next `$`, **_are the salt_**.
- In the example above, the SALT is `/avpfBJ1`

##### Copy Just the Hashes
- Example: If you have the following accounts with hashes in the /etc/shadow file...
```
root:$1$/avpfBJ1$x0z8w5UF9Iv./DR9E9Lid.:14747:0:99999:7:::
sys:$1$fUX6BPOt$Miyc3UpOzQJqz4s5wFD9l0:14742:0:99999:7:::
klog:$1$f2ZVMS4K$R9XkI.CmLdHhdUE3X9jqP0:14742:0:99999:7:::
msfadmin:$1$XN10Zj2c$Rt/zzCW3mLtUWA.ihZjA5/:14684:0:99999:7:::
postgres:$1$Rw35ik.x$MgQgZUuO5pAoUvfJhfcYe/:14685:0:99999:7:::
user:$1$HESu9xrH$k.o3G93DGoXIiQKkPmUgZ0:14699:0:99999:7:::
service:$1$kR3ue7JZ$7GxELDupr5Ohp6cjZ3Bu//:14715:0:99999:7:::
```
- You would copy out the **_second field_** only and save those values to a text file (e.g. hashes.txt): 
```
$1$/avpfBJ1$x0z8w5UF9Iv./DR9E9Lid.
$1$fUX6BPOt$Miyc3UpOzQJqz4s5wFD9l0
$1$f2ZVMS4K$R9XkI.CmLdHhdUE3X9jqP0
$1$XN10Zj2c$Rt/zzCW3mLtUWA.ihZjA5/
$1$Rw35ik.x$MgQgZUuO5pAoUvfJhfcYe/
$1$HESu9xrH$k.o3G93DGoXIiQKkPmUgZ0
$1$kR3ue7JZ$7GxELDupr5Ohp6cjZ3Bu//
```

#### Step 2: Find the Hash Mode
- The most important piece of information here is the hash mode.
- Find it with grep: `hashcat --help | grep SHA512` or `hashcat --help | grep "$6$"`
  - Should be ID 1800
- Or, for MD5: `hashcat --help | grep MD5` or `hashcat --help | grep "$1$"`
  - Should be ID 0500

#### Step 3: Crack (Syntax)
```
hashcat [options] hashfile /path/to/wordlist.txt

# Minimum General: 
hashcat -m [value] -a [value] [hashfile] [wordlist]

# For SHA-512:
hashcat -a 3 -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt

# For MD5:
hashcat -a 0 -m 500 -o cracked.txt hashes.txt /usr/share/wordlists/sqlmap.txt

## Output file format code:
hashcat -a 3 -m 1800 -o hashcat_output.txt --outfile-format=2 hash_msf.txt /usr/share/wordlists/rockyou.txt
```
- Note that your wordlist is **_NOT_** an option. Just tag it on the end.
- 

#### Options (Summary)
- `-a, --attack-mode=NUM` : Attack-mode, see references below
  - Attack mode NUM:
  - `0` = Straight (default dictionary attack)
  - `1` = Combination (tries different combos of works from your wordlist)
  - `2` = Toggle-Case 
  - `3` = Brute-force (used to generate words matching a specific pattern that is useful when a particular trait such as password length or traits are known.)
  - `4` = Permutation
  - `5` = Table-Lookup
  - `8` = Prince
- `-m, --hash-type=NUM` : Hash-type, see references below
  - Hash types NUM, sample:
  - `0` = MD5
  - `100` = SHA1
  - `900` = MD4
  - `1000` = NTLM
  - `1400` = SHA256
  - `1700` = SHA512
  - `1800` = SHA-512(Unix)
- `-o, --outfile=FILE` : Define outfile for recovered hash
- `--outfile-format=NUM` : Define outfile-format for recovered hash, see references below
  - Outfile formats NUM, sample:
  - `1` = hash[:salt]
  - `2` = plain
  - `3` = hash[:salt]:plain 

#### [Show Cracked Passwords](https://hashcat.net/wiki/doku.php?id=frequently_asked_questions#how_can_i_show_previously_cracked_passwords_and_output_them_in_a_specific_format_eg_emailpassword)
- To accomplish this, you need to use the `--show` switch.
- Run the same command you did to crack the passwords, and just add `--show` to the end
```
hashcat -a 0 -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt
hashcat -a 0 -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt --show
```

