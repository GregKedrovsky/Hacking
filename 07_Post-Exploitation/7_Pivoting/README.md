# Pivoting

## Contents
- []()

## Intro

### What is Pivoting?
- Pivoting is a post-exploitation technique that involves utilizing a compromised host (that is connected to other systems and/or networks) to attack other systems on the compromised host's networks (and there could be more than one: external and internal).
  - Pivoting can involve using a compromised target to access other networks to which that target is connected.
  - Or pivoting can involve using a compromised target to access other hosts and resources on the same network (if it is not connected to other networks).
- After gaining access to one host, we can use the ompromised host to exploit other hosts on the same internal network to which we could not access previously.
- Meterpreter provides us with the ability to add a network route to the internal network's subnet and consequently scan and exploit other systems on the network.

### Port Forwarding

| Machine |   External  |  Internal   |   Description   |
|:-------:|:-----------:|:-----------:|:---------------:|
| Kali    | 192.168.1.2 |     none    | attack machine  |
| Vic-1   | 192.168.1.3 | 10.10.10.2  | used as a pivot |
| Vic-2   |     none    | 10.10.10.3  |  final target   |

- In order to understand pivoting, you need to understand port forwarding.
- Consider the above table as an example:
  - The external network (open to the public) is 192.168.1.0/24
  - The internal network (not open to the public) is 10.10.10.0/24
  - In order to reach the internal network, we need to compromise vic-1 and then use it to "pivot" to compromise vic-2 via our access to vic-1.
- Port forwarding is the process of redirecting traffic from a specific port on a target system to a specific port on our (attack) system.
  - We would forward a specific port on vic-2 to our Kali attack machine (forward all the traffic the port on vic-2 receives to a port on our attack machine).
  - This way we can access that port on vic-2 via the port on our local Kali attack machine (because it is receiving the port forwarded from vic-2).
  - If we don't forward the vic-2 port to a port on our Kali machine, we would need something like Nmap on vic-1 in order to do a version scan (`-sV`) on open ports on vic2.
    - We can do a **_port_** scan on vic-2 via vic-1 (MetaSploit provides that functionality).
    - But we cannot do a **_version_** scan on the ports we find open on vic-2.
    - So we need to forward open ports on vic-2 to our Kali machine, and then we can run Nmap `-sV` on the port we chose on our Kali machine to receive the forwarded port from vic-2.
- In the context of pivoting, we can forward a remote port on a previously inaccessible host (vic-2) to a local port on our Kali machine, and in this way we can remotely interact with and exploit the service running on the port.

### Resources & Links
- We are going to use the MetaSploit Framework and Meterpreter to perform our pivoting.
  - MSF and meterpreter already have the necessary tools built into them.
  - This will make it much easier to understand the concepts and techniques.
- NOTES:
  - I followed the [MetaSploit Pivoting Documentation](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html) because the `run autoroute` Meterpreter Script is deprecated. It does appear to still work, though.
  - I used an [online subnet calculator](https://www.adminsub.net/ipv4-subnet-calculator/) to find the subnet and netmask of the networks I was working on (external and internal).

## Techniques & Tools
> The following is from a lab, so all the details are specific to that lab. The process, however, should be replicable in other similar contexts.

### Scenario
- You exploited vic-1 via MetaSploit and currently have a Meterpreter session with elevated (admin) privileges.
- Initial enumeration on the target machine vic-1 (`ipconfig`, etc.) reveals a second (internal) network that we need to scan to see if there are hosts reachable on that internal networkl via vic-1.
- In order to use the compromised vic-1 system to access the network on which vic-2 sits, we need to add a `route`.
  - We access the internal (vic-2) network "through" vic-1 by adding a `route` to the vic-2 subnet (from [MetaSploit Docs](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html#overview)):
  - The route allows us to access vic-2's subnet (and therefore vic-2) through vic-1 from our Kali attack machine.

> Once you have compromised a host that has multiple network adapters you can then use the session that you have obtained on that host to use that host as a pivot, and relay traffic through the compromised host to the target machine that you want to access. This allows you, as an attacker, to access machines on networks that you might not otherwise have access to, by utilizing the access to internal networks that the compromised machine has.

### Meterpreter Script: `autoroute`
- 
```
run autoroute -s [vic-2 subnet]/[CIDR]
```
- `-s` : subnet, CIDR notation

#### What's happening here? 
- The meterpreter session is on vic-1 (which can access vic-2's subnet). So, when we run this meterpreter script, we're adding a route from the meterpreter (from vic-1) to vic-2's internal network.
- That means:
  - We have access from our attack machine to vic-1 via meterpreter.
  - We have access from meterpreter to vic-2.
  - By establishing a route from meterpreter to the vic-2 internal network, we have access to that network from our attack machine via meterpereter.
 
#### Options to Set
- So the two options you'll need to set on the `autoroute` are:
  - SUBNET: vic-2's subnet in CIDR notation
  - SESSION: for your meterpreter on vic-1  (but since this is a meterpreter script, this option is by default)

#### Using the Route
- Background your meterpreter session but stay in the MSF (because this route is established inside MetaSploit; it's not available outside MSF in a term window).
- Now do a portscan: 
```
> use auxiliary/scanner/portscan/tcp
> set RHOSTS 10.10.10.0/24
  # This is the vic-2 internal network
> set PORTS 1-100
  # for a quicker scan of the whole network
> run
```
- This will give you an idea of what hosts are on the internal network (one of which would be vic-2).

#### Problem & Solution
- Meterpreter scripts are depracated.
- So we need to use the `autoroute` module instead...

### MetaSploit Module: `autoroute`
- MetaSploit Documentation: This follows the [Privoting in MetaSploit](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html) instructions.
- Background your meterpreter session and take not of the session ID number.
```
> use /post/multi/manage/autoroute
> set SUBNET [vic-2 internal network address]
> set NETMASK [ /24 or 255.255.255.0 ]
> set SESSION [meterpreter session ID#]
> run
> route
  # prints out the routing table; should display the new route to the vic-2 internal address
> route get
  # shows you the new route is routed through your meterpreter session id#
```

#### Portscan
```
> use auxiliary/scanner/portscan/tcp
> set RHOSTS 10.10.10.0/24
  # This is the vic-2 internal network
> set PORTS 1-100
  # for a quicker scan of the whole network
> run
```
- This will give you an idea of what hosts are on the internal network (one of which would be vic-2: 10.10.10.3)

#### Problem: Service Version Scan
- The port scan will show you (for example) that port 80 is open on vic-2 (10.10.10.3)
- But that all the information you get. If you try to do a service version scan of that port, you get only the response that the port is open.
```
db_nmap -Pn -sV -p 80 10.10.10.3 
```
- The solution to this problem is port forwarding

### Port Forwarding
- 




