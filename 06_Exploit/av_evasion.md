# Antivirus (AV) Evasion

## Contents
- [](#)

## [Defense Evasion](https://attack.mitre.org/tactics/TA0005/)
- Defense evasion consists of techniques that adversaries use to avoid detection throughout their compromise.
- Techniques used for defense evasion include uninstalling/disabling security software or obfuscating/encrypting data and scripts.
- Adversaries also leverage and abuse trusted processes to hide and masquerade their malware.
- Source: MITRE

## AV Detection Methods

### Signature-Based Detection
- An AV signature is a unique sequence of bytes that uniquely identifies malware.
  - As a result, you will have to ensure that your obfuscated exploit or payload does not match any known signature in the AV database.
- We can bypass signature-based detection by modifying the malware's byte sequence, and thereby changing its signature.

### Heuristic-Based Detection
- Heuristic: [def] proceeding to a solution by trial and error or by rules that are only loosely defined.
- This detection method relies on rules or decisions to determine whether a binary is malicious.
- It also looks for specific patterns within the code or program calls.

### Behavior-Based Detection
- Relies on identifying malware by monitoring its behavior (used for newer strains of malware).

## AV Evasion Techniques

### On-Disk Evasion Techniques

#### Obfuscation
- Obfuscation refers to the process of concealing something important, valuable or critical.
- Obfuscation reorganizes code in order to make it harder to analyze or reverse-engineer.

#### Encoding
- Encoding data is a process involving changing data into a new format using a scheme.
- Encoding is a reversible process. Data can be encoded to a new format and decoded to its original format.

#### Packing
- Generate an executable with a new binary structure with a smaller size and thereby provide a payload with a different/unique signature.

#### Crypters
- Encrypts code or payloads and decrypts the encrypted code in memory.
- The decryption key/function is usually stored in a stub. 

### In-Memory Evasion Techniques
- Focuses on manipuation of memory and does not write files to disk.
- Injects payload into a process by leveraging various Windows APIs.
- Payload is then executed in memory in a separate thread. 

## Tools

### [Shellter](https://www.shellterproject.com/)
> Shellter is a dynamic shellcode injection tool, and the first truly dynamic PE infector ever created. It can be used in order to inject shellcode into native Windows applications. The shellcode can be something yours or something generated through a framework, such as Metasploit.> 

- [Documentation](https://www.shellterproject.com/Downloads/Shellter/Readme.txt) | [Kali Docs](https://www.kali.org/tools/shellter/)

#### Installation 
```
apt -y install shellter
```
- There's a hitch: Shellter is a Windows executable file. This means you need to use Wine.
- Wine is a compatibility layer for Linux so Linux users can execute Windows binaries. 

#### WINE
```
dpkg --add-architecture i386
apt update && apt -y install wine32

```
- You may need to install the 32-bit version of WINE (although this may have changed in the latest version of Shellter).
- Shellter (used to?) only supported the production of 32-bit payloads.
- So, you first need to tell your Debian Kali 64-bit system that you want to run 32-bit (i386) programs.
- And then you can install Wine-32.

#### Execute
```
cd /usr/share/windows-resources/shellter/
wine shellter.exe
```
- That should start up Shellter.

#### Payload Binary
- Before you can actually use Shellter, you need a binary (an executable) file to inject your malicious code into.
- Recommendation: small executable and very simplistic in terms of its functionality.
  - Don't use a chrome installer exe or vlc.exe, etc.
- In Kali Linux you are provided with some Windows binaries: `/usr/share/windows-binaries/`
  - This subdir contains several binaries that are used  during a pentest of a Windows targert.
  - Good candidate: `vncviewer.exe`
  - Copy that file and dump it into a working subdir of your choice
- NOTE: When Shellter modifies this file, it will make a backup of the original in the subdir:
  - `/usr/share/windows-resource/shellter/Shellter-Backups/`
 
#### Injection Process
```
wine shelter.exe
```
- Launch Shellter and choose Operation Mode: `A` (auto)
- PE Target: `/home/kali/Desktop/AVBypass/vncviewer.exe`
  - Once you hit enter, it will give you a bunch of info about what it did and what it's doing.
  - It will take about 60-90 seconds to run.
  - Then it dumps you off in another prompt...
- Enable Stealth Mode?
  - This is asking: _Do you want the executable to function as intended_?
  - Example: We are injecting shell code into vncviewer.exe. Do we want vncviewer.exe to actually function or not.
  - Recommendation: YES, we want the original functionality.
  - Therefore, enable stealth mode, choose: `Y`
- Now you get a prompt to select the payload.
  - Each of the listed payloads are self-explanatory.
  - Your choices from which to select are:  (L/C/H)
    - `L` - from the List
    - `C` - custom (like an msfvenom payload you built yourself)
  - Choose: `L`
    - Select Payload by index (number from the list)
  - Set LHOST
  - Set LPORT
 
That should spit out a lot more information and you should get: `Injection: Verified!`

**REMEMBER:**
1. The legitimate, original vncviewer.exe is now stored in the /Shellter-Backups/ subdir
2. The vncviewer.exe in your working subdir is the injected version.

#### Exploitation
- Copy the injected vncviewer.exe over to the target system.
- When you execute it, it will look and function just like vncviewer, but you'll get a reverse shell on your listener on your attack machine. 
  
